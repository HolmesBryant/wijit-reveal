/**
* @author Holmes Bryant <https://github.com/HolmesBryant>
* @license GPL-3.0
*/
export default class WijitCode extends HTMLElement{#t=new AbortController;#e=new AbortController;#i=!1;#s=!1;#n;#r=!1;#h="1";#o=!1;#l=0;#a=!1;static observedAttributes=["edit","highlight","inline","indent","line-numbers","palette"];constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=` <style> :host {--indent: ${this.indent}; --line-number-color: gray; --wrap: pre; display: inline-block; overflow-x: auto; vertical-align: middle; } div {position: relative; font-family: "Courier New", monospace; } pre {font-family: monospace; margin: 0; tab-size: var(--indent); white-space: var(--wrap); } section {display: grid; gap: .5rem; grid-template-columns: max-content 1fr; } textarea {all: inherit; bottom: 0; caret-color: white; color: transparent; display: block; height: 100%; overflow-y: hidden; position: absolute; tab-size: var(--indent); top: 0; width: 100%; } textarea:focus {outline: 2px dashed silver; } .hidden {display: none; } .inline {display: inline; margin: 0; white-space: nowrap; } #line-numbers {color: var(--line-number-color); font-family: monospace; white-space: pre-line; } </style> <section> <div id="line-numbers"></div> <div> <pre><slot></slot></pre> <textarea class="hidden" spellcheck="false"></textarea> </div> </section>`}connectedCallback(){const t=this.shadowRoot.querySelector("slot");this.contentNode=this.shadowRoot.querySelector("pre"),this.textContent=this.resetSpaces(this.getContent()),this.highlight&&this.highlightCode(),this.lineNumbers&&this.addLineNumbers(),t.addEventListener("slotchange",(()=>{this.updateIfNeeded()}),{signal:this.#t.signal})}attributeChangedCallback(t,e,i){this[t=t.replace(/-./g,(t=>t.toUpperCase()[1]))]=i}disconnectedCallback(){this.#t.abort(),this.#e.abort()}updateIfNeeded(t=500,e=this){const i=Date.now();this.#a?i-this.#l>t&&(this.#l=i,this.textContent=this.resetSpaces(this.getContent(e)),this.highlighter&&this.destroyHighlights(),this.lineNumbers&&this.addLineNumbers(),setTimeout((()=>{this.highlight&&this.highlightCode()}),50)):this.#a=!0}async highlightCode(t=this.highlight,e=this){try{return await this.highlighter.highlight(t,e.childNodes[0])}catch(t){throw t}}destroyHighlights(){try{return this.highlighter.removeAll()}catch(t){console.error(t)}}resetSpaces(t){this.needsUpdate=!1,t=t.replace(/^ +/gm,(t=>"\t".repeat(t.length))).trim();const e=t.split("\n"),i=e.at(-1).match(/^\s*/)[0].length,s=new RegExp(`^\\s{${i}}`,"g");return e.map((t=>t.replace(s,""))).join("\n")}getContent(t=this){let e,i;return"textarea"===t.localName?i=t.value:t.firstElementChild&&"textarea"===t.firstElementChild.localName?(e=t.querySelector("textarea"),i=e.value.replace("<\\","<"),e.remove()):i=this.convertHTML(t.innerHTML),i}convertHTML(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}addLineNumbers(){let t=1;const e=this.shadowRoot.querySelector("#line-numbers");e.textContent="";const i=this.textContent.split(/\r?\n/).length,s=document.createElement("div");for(;t<=i;t++){const i=s.cloneNode();i.id="line-"+t,i.textContent=t,e.append(i)}}enableEdit(){const t=this.shadowRoot.querySelector("textarea");t.classList.remove("hidden"),t.value=this.textContent,this.interceptKeyPress(t),t.addEventListener("input",(t=>{this.updateIfNeeded(500,t.target)}),{signal:this.#e.signal})}disableEdit(){this.shadowRoot.querySelector("textarea").classList.add("hidden"),this.#e.abort()}interceptKeyPress(t){t.addEventListener("keydown",(t=>{if("Tab"===t.key){t.preventDefault();const e=t.target,i=e.selectionStart,s=e.selectionEnd,n=e.value.substring(0,i),r=e.value.substring(s);e.value=n+"\t"+r,e.selectionStart=e.selectionEnd=i+1;const h=new Event("input");e.dispatchEvent(h)}}),{signal:this.#e.signal})}get inline(){return this.#r}set inline(t){const e=this.shadowRoot.querySelector("pre");switch(t){case"false":case!1:t=!1,this.removeAttribute("inline"),e&&e.classList.remove("inline"),this.hasAttribute("line-numbers")&&(this.lineNumbers=this.getAttribute("line-numbers"));break;default:t=!0,e&&e.classList.add("inline"),this.lineNumbers=!1}this.#r=t}get indent(){return this.#h}set indent(t){this.style.setProperty("--indent",t),this.#h=t}get highlight(){return this.#s}set highlight(t){switch(t){case"false":case!1:t=!1;break;case"":t="default";default:this.highlighter=this.highlighter||new Highlighter(this)}this.#s=t,this.contentNode&&this.updateIfNeeded()}get edit(){return this.#i}set edit(t){switch(t){case"false":case!1:this.#i=!1,this.contentNode&&this.disableEdit();break;default:this.#i=!0,this.contentNode?this.enableEdit():customElements.whenDefined(this.localName).then((t=>{this.enableEdit()}))}}get lineNumbers(){return this.#o}set lineNumbers(t){const e=this.shadowRoot.querySelector("#line-numbers");switch(t){case"false":case!1:this.#o=!1,e.textContent="";break;default:this.#o=!0,this.contentNode&&this.updateIfNeeded()}}get palette(){return!!this.highlighter&&this.highlighter.palette}set palette(t){this.highlighter?this.highlighter.palette=t:console.error("highlighter has not been initialized")}}
/**
* @author Holmes Bryant <webbmaastaa@gmail.com>
* @license GPL-3.0
*/export class Highlighter{#d;container;suffix="_"+Math.random().toString(36).substring(2,15);defaultColors=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","deeppink"],["number","hsl(32, 93%, 50%)"],["operator","red"],["property","orchid"],["string","hsl(114, 31%, 68%)"],["variable","darkkhaki"],["tag","indianred"]]);defaultSyntaxDef={argument:/(?<=\()[^)]+/g,function:/[\w-]+\s*\(|\)/g,property:/(?<!}[\r\n\s]+)\b([\w\d-]+:(?!:))/g,number:/(?<!\w)[#+-.]?\d+[%\b\.\w]*/g,operator:/=/g,tag:/<\/?[\w-]+|(?<=[\w"])>/g,string:/["'`][^"'`]*["'`]/g,variable:/--[\w\d]+/g,comment:/(<!--|\/\*)([\s\S]*?)(-->|\*\/)/g,keyword:/@[\w]+\b/g};constructor(t,e){return this.container=t,this.palette=e,this}async highlight(t="html",e){if(void 0===window.Highlight)throw new Error("Browser does not support CSS Custom Highlight API");e=e||this.container.childNodes[0]||document.createTextNode("");const i=`highlights${this.suffix}`;document.head.querySelector(`#${i}`)||document.head.append(this.getStyle());try{const i=await this.getSyntax(t);return this.highlightCode(i,e),!0}catch(t){throw console.error("Error loading Highlight Syntax: ",t),t}}async getSyntax(t=this.highlight){if("default"===t)return this.defaultSyntaxDef;if("string"==typeof t){let e=t;/^(http|\.|\/)/.test(t)||(e=`./syntax.${t}.js`);try{t=await import(e)}catch(t){throw t}}return t.default}highlightCode(t={},e){if(e.nodeType!==Node.TEXT_NODE)throw new Error(`Second argument must be a TEXT_NODE (3). Given nodeType is (${e.nodeType})`);let i;const s=e.textContent;for(const n of Object.keys(t)){const r=t[n];if(r){if(Array.isArray(r)){const t=[...new Set(r)].join("|"),n=new RegExp(`\\b(${t})\\b`,"g");i=this.setRanges(n,s,e)}else if(r instanceof Function)i=new Set(r(s,e));else{if(!(r instanceof RegExp))throw console.error(`Invalid syntax definition for ${n}: `,`"${r}"`),new Error(`Invalid syntax definition for ${n}`);i=this.setRanges(r,s,e)}this.setHighlight(i,n)}}return!0}setRanges(t,e,i){const s=new Set,n=e.matchAll(t);for(const t of n){const e=t.index,n=e+t[0].length,r=new Range;r.setStart(i,e),r.setEnd(i,n),s.add(r)}return s}getHighlights(){const t=new Map;return CSS.highlights.forEach(((e,i)=>{i.endsWith(this.suffix)&&t.set(i,e)})),t}setHighlight(t,e="test"){e+=this.suffix;const i=new Highlight(...t);try{return CSS.highlights.set(e,i),!0}catch(t){throw t}}getStyle(){const t=document.createElement("style");let e="";return t.id=`highlights${this.suffix}`,this.palette.forEach(((t,i)=>{e+=`::highlight(${i}${this.suffix}) { color: ${t}}\n`})),t.textContent=e,t}remove(t){CSS.highlights.delete(t+this.suffix)}removeAll(){return CSS.highlights.forEach(((t,e)=>{e.endsWith(this.suffix)&&CSS.highlights.delete(e)})),this.suffix}clearRegistry(){CSS.highlights.clear()}logRegistry(){CSS.highlights.forEach(((t,e)=>{console.log(e,t)}))}get palette(){return this.#d||this.defaultColors}set palette(t){let e;const i=document.head.querySelector(`#highlights${this.suffix}`);if(t&&""!==t&&void 0!==t)if(Array.isArray(t))e=new Map(t);else if(t instanceof Map)e=t;else try{t=JSON.parse(t),e=new Map(t)}catch(t){console.error(t)}else this.#d=null;this.#d=e;const s=this.getStyle();i?document.head.replaceChild(s,i):document.head.append(s)}}document.addEventListener("DOMContentLoaded",customElements.define("wijit-code",WijitCode));
